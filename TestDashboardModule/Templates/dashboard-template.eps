<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pester Test Results Dashboard - IT Infrastructure Focus</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        body { background-color: #f8f9fa; }
        .hero { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 3rem 0; margin-bottom: 2rem; }
        .card { border: none; border-radius: 10px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); transition: transform 0.2s; }
        .card-body { padding: 2rem; }
        .progress { height: 30px; border-radius: 15px; }
        .table { border-radius: 10px; overflow: hidden; }
        .table thead th { background-color: #343a40; color: white; border: none; }
        .table tbody tr { transition: background-color 0.2s; }
        .table tbody tr:hover { background-color: #f1f3f4; }
        .passed { color: #198754; }
        .failed { color: #dc3545; }
        .skipped { color: #ffc107; }
        .status-icon { margin-right: 0.5rem; }
        .collapse-toggle { transition: all 0.3s ease; }
        .collapse-toggle:hover { background-color: rgba(255, 255, 255, 0.1) !important; }
        .collapse-toggle[aria-expanded="true"] .fa-chevron-down { transform: rotate(180deg); }
        .fa-chevron-down { transition: transform 0.3s ease; }
        .card .card-header { border-radius: 10px 10px 0 0; }
        .card .collapse:not(.show) + .card-body { display: none; }
        .card:has(.collapse:not(.show)) .card-header { border-radius: 10px; }
        .statusbadge { top: 2px !important; right: 16px; }
    </style>
</head>
<body>
    <div class="hero">
        <div class="container">
            <h1 class="text-center display-4"><i class="fas fa-chart-line me-3"></i>Pester Test Results Dashboard</h1>
            <p class="text-center lead">Focused on IT Infrastructure Testing</p>
            <p class="text-center">Generated on: <%= $data.GeneratedDate %></p>
        </div>
    </div>

    <div class="container">
        <!-- Summary Cards -->
        <div class="row mb-5">
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-list-ul fa-2x text-primary mb-3"></i>
                        <h5 class="card-title">Total Tests</h5>
                        <h2 class="card-text"><%= $data.TotalTests %></h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-check-circle fa-2x text-success mb-3"></i>
                        <h5 class="card-title">Passed</h5>
                        <h2 class="card-text passed"><%= $data.PassedTests %></h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-times-circle fa-2x text-danger mb-3"></i>
                        <h5 class="card-title">Failed</h5>
                        <h2 class="card-text failed"><%= $data.FailedTests %></h2>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center h-100">
                    <div class="card-body">
                        <i class="fas fa-percentage fa-2x text-info mb-3"></i>
                        <h5 class="card-title">Pass Rate</h5>
                        <h2 class="card-text"><%= $data.PassRate %>%</h2>
                    </div>
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="card mb-5">
            <div class="card-body">
                <h4 class="card-title"><i class="fas fa-chart-bar me-2"></i>Test Pass Rate</h4>
                <div class="progress">
                    <div class="progress-bar bg-success" style="width: <%= $data.PassRate %>%">
                        <%= $data.PassRate %>%
                    </div>
                </div>
            </div>
        </div>

        <!-- Failed Tests Summary -->
        <% if ($data.FailedTestsSummary -and $data.FailedTestsSummary.Count -gt 0) { %>
        <div class="card mb-5 border-danger">
            <div class="card-header bg-danger text-white">
                <h4 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Failed Tests Summary (<%= $data.FailedTestsSummary.Count %>)
                </h4>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">Click on any failed test below to navigate to its category and expand the details:</p>
                <div class="list-group">
                    <% foreach ($failedTest in $data.FailedTestsSummary) { %>
                    <a href="#<%= $failedTest.TestId %>"
                       class="list-group-item list-group-item-action d-flex justify-content-between align-items-center failed-test-link"
                       data-category="<%= $failedTest.CategoryId %>"
                       data-test="<%= $failedTest.TestId %>">
                        <div>
                            <strong><%= $failedTest.TestName %></strong>
                            <br>
                            <small class="text-muted">in <%= $failedTest.CategoryName %></small>
                        </div>
                        <i class="fas fa-external-link-alt text-danger"></i>
                    </a>
                    <% } %>
                </div>
            </div>
        </div>
        <% } %>

        <!-- Test Categories -->
        <% foreach ($main in $data.MainCategories) { %>
        <% $collapseId = "collapse-" + $main.Name.Replace(" ", "").Replace(".", "") %>
        <div class="card mb-5">
            <div class="card-header <%= if ($main.HasFailures) { 'bg-danger' } else { 'bg-primary' } %> text-white">
                <h4 class="mb-0">
                    <button class="btn btn-link text-white text-decoration-none w-100 text-start collapse-toggle" type="button" data-bs-toggle="collapse" data-bs-target="#<%= $collapseId %>" aria-expanded="false" aria-controls="<%= $collapseId %>">
                        <i class="fas fa-folder me-2"></i><%= $main.Name %> (<%= $main.TotalCount %>)
                        <div class="float-end d-flex align-items-center gap-2">
                            <span class="badge statusbadge bg-success"><%= $main.PassedCount %> Passed</span>
                            <% if ($main.FailedCount -gt 0) { %>
                            <span class="badge statusbadge <%= if ($main.HasFailures) { 'bg-light text-danger' } else { 'bg-danger' } %>"><%= $main.FailedCount %> Failed</span>
                            <% } %>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </button>
                </h4>
            </div>
            <div id="<%= $collapseId %>" class="collapse">
                <div class="card-body">
                <% if ($main.TotalCount -eq 0) { %>
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>No tests found in this category.
                    </div>
                <% } else { %>
                    <div class="row">
                        <% $subs = $main.Group | Group-Object SubCategory | Sort-Object Name %>
                        <% foreach ($sub in $subs) { %>
                        <div class="col-lg-6 col-md-12 mb-4">
                            <div class="card h-100">
                                <div class="card-header bg-light">
                                    <h5><i class="fas fa-list me-2"></i><%= $sub.Name %> (<%= $sub.Group.Count %>)</h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <% foreach ($test in $sub.Group) { %>
                                        <div id="<%= $test.TestId %>" class="col-12 mb-3">
                                            <div class="card h-100 <%= if ($test.Result -eq 'Passed') { 'border-success' } elseif ($test.Result -eq 'Failed') { 'border-danger' } else { 'border-warning' } %>">
                                                <div class="card-body">
                                                    <h6 class="card-title"><%= $test.DisplayName %></h6>
                                                    <p class="card-text mb-1">
                                                        <i class="fas fa-clock me-1"></i> Time: <%= $test.Time %>s
                                                    </p>
                                                    <p class="card-text">
                                                        <span class="<%= if ($test.Result -eq 'Passed') { 'text-success' } elseif ($test.Result -eq 'Failed') { 'text-danger' } else { 'text-warning' } %>">
                                                            <i class="<%= if ($test.Result -eq 'Passed') { 'fas fa-check-circle' } elseif ($test.Result -eq 'Failed') { 'fas fa-times-circle' } else { 'fas fa-exclamation-triangle' } %> me-1"></i>
                                                            <%= $test.Result %>
                                                        </span>
                                                    </p>
                                                    <% if ($test.Result -eq 'Failed' -and $test.FailureMessage) { %>
                                                    <div class="alert alert-danger mt-2" role="alert">
                                                        <i class="fas fa-exclamation-triangle me-1"></i><strong>Failure:</strong> <%= $test.FailureMessage %>
                                                    </div>
                                                    <% if ($test.StackTrace) { %>
                                                    <div class="mt-2">
                                                        <button class="btn btn-warning btn-sm" type="button" data-bs-toggle="collapse" data-bs-target="#stacktrace-<%= $test.TestId %>" aria-expanded="false" aria-controls="stacktrace-<%= $test.TestId %>">
                                                            <i class="fas fa-code me-1"></i>Show Stack Trace
                                                        </button>
                                                        <div class="collapse mt-2" id="stacktrace-<%= $test.TestId %>">
                                                            <div class="alert alert-warning" role="alert">
                                                                <h6 class="alert-heading">
                                                                    <i class="fas fa-code-branch me-1"></i>Stack Trace
                                                                </h6>
                                                                <pre class="mb-0" style="font-size: 0.875rem; white-space: pre-wrap;"><%= $test.StackTrace %></pre>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% } %>
                                                    <% } %>
                                                </div>
                                            </div>
                                        </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <% } %>
                    </div>
                <% } %>
                </div>
            </div>
        </div>
        <% } %>

        <!-- Footer -->
        <footer class="text-center mt-5 py-4 bg-light">
            <p class="mb-0 text-muted">
                <i class="fas fa-cogs me-2"></i>Generated by Pester Test Dashboard Tool | Powered by EPS & Bootstrap
            </p>
        </footer>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Handle failed test link clicks
        document.addEventListener('DOMContentLoaded', function() {
            const failedTestLinks = document.querySelectorAll('.failed-test-link');

            failedTestLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();

                    const categoryId = this.getAttribute('data-category');
                    const testId = this.getAttribute('data-test');
                    const categoryElement = document.getElementById(categoryId);
                    const testElement = document.getElementById(testId);

                    if (categoryElement && testElement) {
                        // Check if category is already expanded
                        const isExpanded = categoryElement.classList.contains('show');

                        if (isExpanded) {
                            // Category is already expanded, just scroll to the test
                            testElement.scrollIntoView({
                                behavior: 'smooth',
                                block: 'center'
                            });

                            // Highlight the card within the test element
                            const cardElement = testElement.querySelector('.card');
                            if (cardElement) {
                                cardElement.style.transition = 'box-shadow 0.3s ease';
                                cardElement.style.boxShadow = '0 0 15px rgba(220, 53, 69, 0.8)';
                                setTimeout(() => {
                                    cardElement.style.boxShadow = '';
                                }, 3000);
                            }
                        } else {
                            // Category is collapsed, expand it first, then scroll
                            const collapse = new bootstrap.Collapse(categoryElement, {
                                show: true
                            });

                            // Wait for the collapse animation to complete, then scroll to the specific test
                            setTimeout(() => {
                                testElement.scrollIntoView({
                                    behavior: 'smooth',
                                    block: 'center'
                                });

                                // Highlight the card within the test element
                                const cardElement = testElement.querySelector('.card');
                                if (cardElement) {
                                    cardElement.style.transition = 'box-shadow 0.3s ease';
                                    cardElement.style.boxShadow = '0 0 15px rgba(220, 53, 69, 0.8)';
                                    setTimeout(() => {
                                        cardElement.style.boxShadow = '';
                                    }, 3000);
                                }
                            }, 350); // Wait for collapse animation to complete
                        }
                    }
                });
            });
        });
    </script>
</body>
</html>
